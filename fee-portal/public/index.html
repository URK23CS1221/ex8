<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Fee Portal - Mini UI</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px;max-width:780px}
    fieldset{margin-bottom:16px;padding:12px;border-radius:6px}
    label{display:block;margin:6px 0;font-weight:600}
    input,select,button{padding:8px;margin-top:6px;width:100%;box-sizing:border-box}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    pre{background:#f5f5f5;padding:10px;border-radius:6px;max-height:240px;overflow:auto}
  </style>
</head>
<body>
  <h2>Fee Portal - Mini UI</h2>

  <fieldset>
    <legend>Auth</legend>
    <label>Username<input id="u_username" placeholder="admin"/></label>
    <label>Password<input id="u_password" type="password" placeholder="password"/></label>
    <div class="row">
      <button id="btnLogin">Login</button>
      <button id="btnSignup">Signup (create admin)</button>
    </div>
    <p>Token: <small id="tokenDisplay">none</small></p>
  </fieldset>

  <fieldset>
    <legend>Create Student</legend>
    <label>Student ID<input id="s_studentId" placeholder="S001"/></label>
    <label>Name<input id="s_name" placeholder="John Doe"/></label>
    <label>Class<input id="s_class" placeholder="10A"/></label>
    <label>Total Fee<input id="s_totalFee" type="number" placeholder="50000"/></label>
    <button id="btnCreateStudent">Create Student</button>
  </fieldset>

  <fieldset>
    <legend>Record Payment</legend>
    <label>Student ID<input id="p_studentId" placeholder="S001"/></label>
    <label>Amount<input id="p_amount" type="number" placeholder="1000"/></label>
    <label>Method
      <select id="p_method">
        <option>cash</option><option>card</option><option>online</option><option>cheque</option>
      </select>
    </label>
    <label>Reference<input id="p_reference" placeholder="TXN123"/></label>
    <label>Received By<input id="p_receivedBy" placeholder="cashier1"/></label>
    <button id="btnRecordPayment">Record Payment</button>
  </fieldset>

  <fieldset>
    <legend>Query Payments</legend>
    <label>Student ID<input id="q_studentId" placeholder="S001"/></label>
    <div class="row">
      <button id="btnGetPayments">Get Payments</button>
      <button id="btnClear">Clear Output</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>Output</legend>
    <pre id="output">...</pre>
  </fieldset>

<script>
const apiBase = location.origin.includes('file:') ? 'http://localhost:4000' : '';
const out = el => document.getElementById('output').textContent = typeof el === 'string' ? el : JSON.stringify(el, null, 2);
const tokDisp = v => document.getElementById('tokenDisplay').textContent = v ? (v.slice(0,40) + '...') : 'none';
function token(){ return localStorage.getItem('fee_token') || ''; }
function authHeaders(){ const t = token(); return t ? {'Authorization':'Bearer '+t,'Content-Type':'application/json'} : {'Content-Type':'application/json'} }

document.getElementById('btnSignup').onclick = async () => {
  const username = document.getElementById('u_username').value || 'admin';
  const password = document.getElementById('u_password').value || 'admin123';
  const res = await fetch(apiBase + '/api/auth/signup', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ username, password, role:'admin' })
  });
  out(await res.json());
};

document.getElementById('btnLogin').onclick = async () => {
  const username = document.getElementById('u_username').value || 'admin';
  const password = document.getElementById('u_password').value || 'admin123';
  const res = await fetch(apiBase + '/api/auth/login', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ username, password })
  });
  const j = await res.json();
  if(j.token){ localStorage.setItem('fee_token', j.token); tokDisp(j.token); out('login ok'); }
  else out(j);
};

document.getElementById('btnCreateStudent').onclick = async () => {
  const body = {
    studentId: document.getElementById('s_studentId').value,
    name: document.getElementById('s_name').value,
    class: document.getElementById('s_class').value,
    totalFee: Number(document.getElementById('s_totalFee').value || 0)
  };
  const res = await fetch(apiBase + '/api/students', { method:'POST', headers: authHeaders(), body: JSON.stringify(body) });
  out(await res.json());
};

document.getElementById('btnRecordPayment').onclick = async () => {
  const body = {
    studentId: document.getElementById('p_studentId').value,
    amount: Number(document.getElementById('p_amount').value || 0),
    method: document.getElementById('p_method').value,
    reference: document.getElementById('p_reference').value,
    receivedBy: document.getElementById('p_receivedBy').value || 'admin'
  };
  const res = await fetch(apiBase + '/api/payments', { method:'POST', headers: authHeaders(), body: JSON.stringify(body) });
  out(await res.json());
};

document.getElementById('btnGetPayments').onclick = async () => {
  const sid = document.getElementById('q_studentId').value;
  const url = apiBase + '/api/payments' + (sid ? '?studentId=' + encodeURIComponent(sid) : '');
  const res = await fetch(url, { headers: authHeaders() });
  out(await res.json());
};

document.getElementById('btnClear').onclick = () => out('cleared');

window.onload = () => { tokDisp(token()); if(!apiBase) console.warn('If this file is opened via file://, API base is http://localhost:4000'); };
</script>
</body>
</html>
